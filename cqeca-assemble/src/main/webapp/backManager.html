<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="../css/backend.css"/>
    <link rel="stylesheet" href="../css/pagination.css"/>
    <link rel="stylesheet" href="../css/font-awesome.css"/>

</head>
<body>

<div id="b-content">
    <h1>后台文章管理</h1>
    <div class="b-manager">
        <div class="b-manager-list">
            <ul></ul>
        </div>
        <div id="pagination"></div>
        <div class="cb"></div>
    </div>
    <form action="/cqeca/manager/add_article" method="get">
    <div class="b-add-post"><button type="submit">新增文章</button></div>
    </form>
    <input type="hidden" class="article_list" id="article_list"  value="${list}"/>
</div>

<script type="text/javascript" src="../js/jquery-1.10.0.min.js"></script>
<script type="text/javascript" src="../js/jquery.pagination.js"></script>
<script type="text/javascript">

   // var testData = eval($('#article_list').val());
    var testData = eval(${list});
    var _ = {
        pageselectCallback: function(page_index, jq){
            // Get number of elements per pagionation page from form
            var items_per_page = 15,
                max_elem = Math.min((page_index + 1) * items_per_page, testData.length),
                list = [];

            // Iterate through a selection of the content and build an HTML string
            // TODO 把文章链接加入href，提供预览功能
            for (var i = page_index * items_per_page; i < max_elem; i++) {
                var item = testData[i];
                list.push('<li data-id="' + item['id'] + '"><span class="post-remove"><a href="javascript:;" title="删除"><i class="fa fa-remove"></i></a></span><span>' + item['date'] + '</span><span>' + item['cate'] + '</span><span class="pre-post"><a href="#">' + item['title'] + '</a></span></li>');

            }
            // Replace old content with new content
            $('ul', $('.b-manager-list')).empty().append(list.join(''));

            _.bindEvent($('li'),$('.post-remove', $('ul')));

            // Prevent click event propagation
            return false;
        },
        bindEvent: function (o1, o2) {
            o1.mouseover(function () {
                $(this).find('.post-remove').css('visibility', 'visible');
            }).mouseleave(function () {
                $(this).find('.post-remove').css('visibility', 'hidden');
            });
            o2.click(function () {
                var thiz = $(this),
                    id = thiz.parent('li').attr('data-id');
                //  这个删除行是临时代码
                thiz.parents('li').remove();

                // 如果接口好了，用以下代码
//                req.deletePostById({data: id}, function (data) {
//                    // if success, remove the relevant DOM
//                    if (data['code'] === 200) {
//                        thiz.parents('li').remove();
//                    } else {
//                        console.log('Error!');
//                    }
//                });
            });
        }
    };

    var req = {
        getAllPost: function (options, callback) {
            $.ajax($.extend({
                type: 'POST',
                url: '/getAllPost',
                dataType: 'JSON'
            }, options, true)).done(function(data){
                if (data && $.isFunction(callback)) {
                    callback(data);
                }
            });
        },
        deletePostById: function (options, callback) {
            $.ajax($.extend({
                type: 'POST',
                url: '/cqeca/manager/delete',
                dataType: 'JSON'
            }, options, true)).done(function(data){
                if (data && $.isFunction(callback)) {
                    callback(data);
                }
            });
        }
    };

    $(function () {

        // TODO 接口好了，就用此方法
//        req.getAllPost({}, function (data) {
//            // init the pagination
//            $("#Pagination").pagination(data.length, {
//                callback: _.pageselectCallback,
//                prev_text: "前一页",
//                next_text: "后一页"
//            });
//        });

        // init the pagination
        $("#pagination").pagination(testData.length, {
            callback: _.pageselectCallback,
            prev_text: "前一页",
            next_text: "后一页"
        });

    });
</script>
</body>
</html>